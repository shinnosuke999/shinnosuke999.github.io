<html>

<head>
  <title>MAKER DEMO06</title>

  <script type="text/javascript" src="libs/polyfill.js"></script> 
  <script type="text/javascript" src="cv.js"></script> 
  <script type="text/javascript" src="aruco.js"></script> 

  <script>
    var camera, canvas, context, imageData, pixels, detector;
    var debugImage, warpImage, homographyImage;

    function onLoad(){
      camera = document.getElementById("video");
      canvas = document.getElementById("canvas");
      context = canvas.getContext("2d", { willReadFrequently: true });
      
      camera.width = 320;
      camera.height = 240;
      
      canvas.width = parseInt(canvas.style.width);
      canvas.height = parseInt(canvas.style.height);
      
      if (navigator.mediaDevices === undefined) {
        navigator.mediaDevices = {};
      }
      
      if (navigator.mediaDevices.getUserMedia === undefined) {
        navigator.mediaDevices.getUserMedia = function(constraints) {
          var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
          
          if (!getUserMedia) {
            return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
          }

          return new Promise(function(resolve, reject) {
            getUserMedia.call(navigator, constraints, resolve, reject);
          });
        }
      }
      
      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then(function(stream) {
          if ("srcObject" in camera) {
            camera.srcObject = stream;
          } else {
            camera.src = window.URL.createObjectURL(stream);
          }
          camera.play(); // カメラのストリームを再生
        })
        .catch(function(err) {
          console.log(err.name + ": " + err.message);
        }
      );
        
      imageData = context.getImageData(0, 0, camera.width, camera.height);
      pixels = [];
      detector = new AR.Detector();
      
      debugImage = context.createImageData(camera.width, camera.height);
      
      requestAnimationFrame(tick);
    }

    function tick() {
      if (camera.readyState === camera.HAVE_ENOUGH_DATA) {
        context.drawImage(camera, 0, 0, canvas.width, canvas.height);
        imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        var markers = detector.detect(imageData);
        
        if (markers.length > 0) {
          var marker = markers[0];
          displayMarkerId(marker.id);
        } else {
          displayMarkerId("マーカー認識中");
        }
      }
      requestAnimationFrame(tick);
    }

    function displayMarkerId(id) {
      var markerIdElement = document.getElementById("marker-id");
      markerIdElement.textContent = "マーカーID: " + id;
    }

    window.onload = onLoad;
  </script>

</head>

<body style="font-family: monospace;">

  <center>
    <div style="margin: 10px;"><strong>-= Augmented Reality Marker Detector =-</strong></div>
    <video id="video" autoplay="true" style="width:320px; height:240px; display:none;"></video>
    <canvas id="canvas" style="width:960px; height:620px;"></canvas>
    <div style="margin: 15px;"><strong>Powered by <a href="http://code.google.com/p/js-aruco/">js-aruco</a></strong></div>
  </center>
  <div id="marker-id" style="position: absolute; bottom: 10px; left: 10px; color: white; background-color: black; padding: 5px;">マーカー認識中</div>

</body>
  
</html>