<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>AR Marker Detection</title>
</head>
<body>
    <video id="video" width="640" height="480" autoplay="true" style="display:none;"></video>
    <canvas id="canvas" width="640" height="480"></canvas>

    <script type="text/javascript" src="lib/cv.js"></script>
    <script type="text/javascript" src="lib/aruco.js"></script>
    <script type="text/javascript" src="lib/posit1.js"></script>
    <script type="text/javascript" src="lib/posit2.js"></script>
    <script type="text/javascript" src="lib/svd.js"></script>
    <script type="text/javascript" src="app.js"></script>
</body>
</html>

// app.js
var video, canvas, context, imageData, detector;

function onLoad(){
    video = document.getElementById("video");
    canvas = document.getElementById("canvas");
    context = canvas.getContext("2d");

    canvas.width = parseInt(canvas.style.width);
    canvas.height = parseInt(canvas.style.height);
    
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
            video.srcObject = stream;
            video.play();
        })
        .catch(function(err) {
            console.log("An error occurred: " + err);
        });
    
    detector = new AR.Detector();
    requestAnimationFrame(tick);
}

function tick(){
    requestAnimationFrame(tick);
    
    if (video.readyState === video.HAVE_ENOUGH_DATA){
        snapshot();
        var markers = detector.detect(imageData);
        drawCorners(markers);
        drawId(markers);
    }
}

function snapshot(){
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    imageData = context.getImageData(0, 0, canvas.width, canvas.height);
}

function drawCorners(markers){
    var corners, corner, i, j;
    
    context.lineWidth = 3;

    for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].corners;
        
        context.strokeStyle = "red";
        context.beginPath();
        
        for (j = 0; j !== corners.length; ++ j){
            corner = corners[j];
            context.moveTo(corner.x, corner.y);
            corner = corners[(j + 1) % corners.length];
            context.lineTo(corner.x, corner.y);
        }

        context.stroke();
        context.closePath();
        
        context.strokeStyle = "green";
        context.strokeRect(corners[0].x - 2, corners[0].y - 2, 4, 4);
    }
}

function drawId(markers){
    var corners, corner, x, y, i, j;
    
    context.strokeStyle = "blue";
    context.lineWidth = 1;
    
    for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].corners;
        
        x = Infinity;
        y = Infinity;
        
        for (j = 0; j !== corners.length; ++ j){
            corner = corners[j];
            
            x = Math.min(x, corner.x);
            y = Math.min(y, corner.y);
        }
        
        context.strokeText(markers[i].id, x, y)
    }
}

window.onload = onLoad;