<!DOCTYPE html>
<html>
<head>
    <title>Demo01-03</title>
    <style>
        #canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
        }
    </style>
</head>
<body>
    <video id="video" style="display:none;"></video>
    <canvas id="canvas"></canvas>

    <script src="lib/cv.js"></script>
    <script src="lib/aruco.js"></script>

    <script>
        let video, canvas, context, imageData, detector;

        function init() {
            video = document.getElementById("video");
            canvas = document.getElementById("canvas");
            context = canvas.getContext("2d");

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                })
                .catch(function(err) {
                    console.log("カメラエラー: " + err);
                });

            detector = new AR.Detector();

            requestAnimationFrame(tick);
        }

        function tick() {
            requestAnimationFrame(tick);

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                snapshot();

                var markers = detector.detect(imageData);
                console.log("検出されたマーカー:", markers);

                drawCorners(markers);
                drawId(markers);
            }
        }

        function snapshot() {
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        }

        function drawCorners(markers) {
            context.lineWidth = 3;

            for (let i = 0; i < markers.length; i++) {
                let corners = markers[i].corners;

                context.strokeStyle = "red";
                context.beginPath();

                for (let j = 0; j < corners.length; j++) {
                    let corner = corners[j];
                    context.moveTo(corner.x, corner.y);
                    corner = corners[(j + 1) % corners.length];
                    context.lineTo(corner.x, corner.y);
                }

                context.stroke();
                context.closePath();
            }
        }

        function drawId(markers) {
            context.strokeStyle = "blue";
            context.lineWidth = 1;

            for (let i = 0; i < markers.length; i++) {
                let corners = markers[i].corners;
                let x = corners[0].x;
                let y = corners[0].y;

                context.strokeText(markers[i].id, x, y);
            }
        }

        window.onload = init;
    </script>
</body>
</html>